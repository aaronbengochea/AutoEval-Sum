services:

  # ── DynamoDB Local ──────────────────────────────────────────────────────────
  dynamodb-local:
    image: amazon/dynamodb-local:latest
    container_name: autoeval-dynamodb
    ports:
      - "8000:8000"
    command: -jar DynamoDBLocal.jar -sharedDb -dbPath /data
    user: root
    volumes:
      - dynamodb-data:/data
    networks:
      - autoeval
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:8000 -o /dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── DynamoDB table setup (one-shot, idempotent) ────────────────────────────
  setup-dynamo:
    build:
      context: ./apps/backend
      dockerfile: Dockerfile
    container_name: autoeval-setup-dynamo
    env_file:
      - .env
    environment:
      DYNAMODB_ENDPOINT_URL: http://dynamodb-local:8000
    command: ["python", "scripts/setup_dynamodb.py"]
    depends_on:
      dynamodb-local:
        condition: service_healthy
    networks:
      - autoeval
    restart: "no"

  # ── Pinecone index setup (one-shot, idempotent) ────────────────────────────
  setup-pinecone:
    build:
      context: ./apps/backend
      dockerfile: Dockerfile
    container_name: autoeval-setup-pinecone
    env_file:
      - .env
    command: ["python", "scripts/setup_pinecone.py"]
    networks:
      - autoeval
    restart: "no"

  # ── Corpus ingestion setup (one-shot, idempotent) ─────────────────────────
  setup-corpus:
    build:
      context: ./apps/backend
      dockerfile: Dockerfile
    container_name: autoeval-setup-corpus
    env_file:
      - .env
    environment:
      DYNAMODB_ENDPOINT_URL: http://dynamodb-local:8000
    volumes:
      - ./data:/app/data
    command: ["python", "scripts/setup_corpus.py"]
    depends_on:
      setup-dynamo:
        condition: service_completed_successfully
    networks:
      - autoeval
    restart: "no"

  # ── Backend ─────────────────────────────────────────────────────────────────
  backend:
    build:
      context: ./apps/backend
      dockerfile: Dockerfile
    container_name: autoeval-backend
    ports:
      - "8080:8080"
    env_file:
      - .env
    environment:
      DYNAMODB_ENDPOINT_URL: http://dynamodb-local:8000
    volumes:
      - ./data:/app/data
    depends_on:
      setup-dynamo:
        condition: service_completed_successfully
      setup-pinecone:
        condition: service_completed_successfully
      setup-corpus:
        condition: service_completed_successfully
    networks:
      - autoeval
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/health/ready || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3

  # ── Frontend ─────────────────────────────────────────────────────────────────
  frontend:
    build:
      context: ./apps/frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8080}
    container_name: autoeval-frontend
    ports:
      - "3000:3000"
    environment:
      BACKEND_URL: http://backend:8080
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - autoeval

# ── Volumes ──────────────────────────────────────────────────────────────────
volumes:
  dynamodb-data:

# ── Networks ─────────────────────────────────────────────────────────────────
networks:
  autoeval:
    driver: bridge
