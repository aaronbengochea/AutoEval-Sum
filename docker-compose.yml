services:

  # ── DynamoDB Local ──────────────────────────────────────────────────────────
  dynamodb-local:
    image: amazon/dynamodb-local:latest
    container_name: autoeval-dynamodb
    ports:
      - "8000:8000"
    command: -jar DynamoDBLocal.jar -sharedDb -dbPath /data
    volumes:
      - dynamodb-data:/data
    networks:
      - autoeval
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8000/shell/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── Backend ─────────────────────────────────────────────────────────────────
  backend:
    build:
      context: ./apps/backend
      dockerfile: Dockerfile
    container_name: autoeval-backend
    ports:
      - "8080:8080"
    env_file:
      - .env
    environment:
      # Override endpoint so backend reaches the compose service, not localhost
      DYNAMODB_ENDPOINT_URL: http://dynamodb-local:8000
    volumes:
      - ./data:/app/data
    depends_on:
      dynamodb-local:
        condition: service_healthy
    networks:
      - autoeval
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3

  # ── Frontend ─────────────────────────────────────────────────────────────────
  frontend:
    build:
      context: ./apps/frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8080}
    container_name: autoeval-frontend
    ports:
      - "3000:3000"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - autoeval

# ── Volumes ──────────────────────────────────────────────────────────────────
volumes:
  dynamodb-data:

# ── Networks ─────────────────────────────────────────────────────────────────
networks:
  autoeval:
    driver: bridge
